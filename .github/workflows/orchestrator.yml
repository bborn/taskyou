# .github/workflows/orchestrator.yml
#
# Processes tasks from the issue queue automatically.
# Triggers when a new issue is created with status:queued label.

name: Task Orchestrator

on:
  issues:
    types: [opened, labeled]

permissions:
  issues: write
  contents: read

env:
  ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

jobs:
  # Only run on queued tasks
  should-process:
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
      task_type: ${{ steps.check.outputs.task_type }}
      project: ${{ steps.check.outputs.project }}
    steps:
      - name: Check if should process
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            const labels = context.payload.issue.labels.map(l => l.name);
            
            // Only process queued tasks
            if (!labels.includes('status:queued')) {
              core.setOutput('should_run', 'false');
              return;
            }
            
            // Don't re-process
            if (labels.includes('status:processing') || 
                labels.includes('status:ready') ||
                labels.includes('status:blocked')) {
              core.setOutput('should_run', 'false');
              return;
            }
            
            core.setOutput('should_run', 'true');
            
            // Determine type
            if (labels.includes('type:code')) {
              core.setOutput('task_type', 'code');
            } else if (labels.includes('type:writing')) {
              core.setOutput('task_type', 'writing');
            } else if (labels.includes('type:thinking')) {
              core.setOutput('task_type', 'thinking');
            } else {
              core.setOutput('task_type', 'auto');
            }
            
            // Determine project
            const projectLabel = labels.find(l => l.startsWith('project:'));
            core.setOutput('project', projectLabel ? projectLabel.replace('project:', '') : 'unknown');

  # Mark as processing
  start-processing:
    needs: should-process
    if: needs.should-process.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Update labels
        uses: actions/github-script@v7
        with:
          script: |
            // Remove queued, add processing
            await github.rest.issues.removeLabel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              name: 'status:queued'
            }).catch(() => {});
            
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['status:processing']
            });

  # Route to appropriate processor
  process-code:
    needs: [should-process, start-processing]
    if: needs.should-process.outputs.task_type == 'code'
    runs-on: self-hosted  # Needs Claude Code installed
    steps:
      - name: Get task details
        id: task
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            core.setOutput('title', issue.title);
            core.setOutput('body', issue.body || '');
            core.setOutput('number', issue.number);
            return issue;

      - name: Determine target repo
        id: repo
        run: |
          PROJECT="${{ needs.should-process.outputs.project }}"
          case "$PROJECT" in
            offerlab)
              echo "repo=bborn/offerlab" >> $GITHUB_OUTPUT
              echo "name=offerlab" >> $GITHUB_OUTPUT
              ;;
            influencekit)
              echo "repo=bborn/influencekit" >> $GITHUB_OUTPUT
              echo "name=influencekit" >> $GITHUB_OUTPUT
              ;;
            *)
              echo "repo=" >> $GITHUB_OUTPUT
              echo "name=unknown" >> $GITHUB_OUTPUT
              ;;
          esac

      - name: Checkout target repo
        if: steps.repo.outputs.repo != ''
        uses: actions/checkout@v4
        with:
          repository: ${{ steps.repo.outputs.repo }}
          token: ${{ secrets.REPO_ACCESS_TOKEN }}
          fetch-depth: 0
          path: workspace

      - name: Create worktree
        if: steps.repo.outputs.repo != ''
        id: worktree
        working-directory: workspace
        run: |
          BRANCH="task-${{ steps.task.outputs.number }}"
          git checkout -b "$BRANCH"
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT

      - name: Run Claude Code
        if: steps.repo.outputs.repo != ''
        id: claude
        working-directory: workspace
        run: |
          PROMPT="Task #${{ steps.task.outputs.number }}: ${{ steps.task.outputs.title }}

          ${{ steps.task.outputs.body }}

          Instructions:
          1. Understand the task
          2. Explore relevant code
          3. Implement the solution
          4. Write tests if applicable
          5. Commit with a clear message

          When complete, output: TASK_COMPLETE
          If you need clarification, output: NEEDS_CLARIFICATION: <question>
          If blocked, output: TASK_BLOCKED: <reason>"

          # Run Claude Code
          OUTPUT=$(claude -p "$PROMPT" \
            --allowedTools "Read,Edit,Write,Bash(git:*),Bash(npm:*),Bash(yarn:*),Bash(bundle:*),Bash(rails:*),Bash(rspec:*)" \
            --max-turns 30 \
            2>&1) || true

          # Determine result
          if echo "$OUTPUT" | grep -q "TASK_COMPLETE"; then
            echo "result=complete" >> $GITHUB_OUTPUT
          elif echo "$OUTPUT" | grep -q "NEEDS_CLARIFICATION"; then
            echo "result=blocked" >> $GITHUB_OUTPUT
            echo "message=$(echo "$OUTPUT" | grep 'NEEDS_CLARIFICATION' | head -1)" >> $GITHUB_OUTPUT
          else
            echo "result=blocked" >> $GITHUB_OUTPUT
            echo "message=Task did not complete successfully" >> $GITHUB_OUTPUT
          fi

      - name: Push and create PR
        if: steps.claude.outputs.result == 'complete' && steps.repo.outputs.repo != ''
        id: pr
        working-directory: workspace
        env:
          GH_TOKEN: ${{ secrets.REPO_ACCESS_TOKEN }}
        run: |
          git push -u origin "${{ steps.worktree.outputs.branch }}"
          
          PR_URL=$(gh pr create \
            --title "${{ steps.task.outputs.title }}" \
            --body "Closes bborn/workflow#${{ steps.task.outputs.number }}

          ---
          *Automated by Task Orchestrator*" \
            --head "${{ steps.worktree.outputs.branch }}")
          
          echo "url=$PR_URL" >> $GITHUB_OUTPUT

      - name: Update issue - success
        if: steps.claude.outputs.result == 'complete'
        uses: actions/github-script@v7
        with:
          script: |
            // Add comment with PR link
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `‚úÖ **Task completed!**\n\nPR created: ${{ steps.pr.outputs.url }}`
            });
            
            // Update labels
            await github.rest.issues.removeLabel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              name: 'status:processing'
            });
            
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['status:ready']
            });

      - name: Update issue - blocked
        if: steps.claude.outputs.result == 'blocked' || steps.repo.outputs.repo == ''
        uses: actions/github-script@v7
        with:
          script: |
            const message = `${{ steps.claude.outputs.message }}` || 'Could not determine target repository';
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `‚ùì **Need clarification**\n\n${message}`
            });
            
            await github.rest.issues.removeLabel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              name: 'status:processing'
            });
            
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['status:blocked']
            });

  # Writing tasks - use Claude API
  process-writing:
    needs: [should-process, start-processing]
    if: needs.should-process.outputs.task_type == 'writing'
    runs-on: ubuntu-latest
    steps:
      - name: Get task details
        id: task
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            core.setOutput('title', issue.title);
            core.setOutput('body', issue.body || '');
            return issue;

      - name: Generate content
        id: generate
        run: |
          PROMPT="You are a skilled writer. Please complete this task:

          Task: ${{ steps.task.outputs.title }}

          Details: ${{ steps.task.outputs.body }}

          Write the requested content. Be professional, clear, and match the appropriate tone.
          Output only the final content, no meta-commentary."

          RESPONSE=$(curl -s https://api.anthropic.com/v1/messages \
            -H "Content-Type: application/json" \
            -H "x-api-key: $ANTHROPIC_API_KEY" \
            -H "anthropic-version: 2023-06-01" \
            -d "{
              \"model\": \"claude-sonnet-4-20250514\",
              \"max_tokens\": 4096,
              \"messages\": [{\"role\": \"user\", \"content\": $(echo "$PROMPT" | jq -Rs .)}]
            }")

          CONTENT=$(echo "$RESPONSE" | jq -r '.content[0].text')
          
          # Save for comment (escape for GitHub)
          echo "content<<EOF" >> $GITHUB_OUTPUT
          echo "$CONTENT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Post result
        uses: actions/github-script@v7
        with:
          script: |
            const content = `${{ steps.generate.outputs.content }}`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `‚úÖ **Content generated:**\n\n---\n\n${content}\n\n---\n\n*Copy the above content to use it.*`
            });
            
            // Update labels
            await github.rest.issues.removeLabel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              name: 'status:processing'
            });
            
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['status:ready']
            });

  # Thinking tasks - analysis with extended thinking
  process-thinking:
    needs: [should-process, start-processing]
    if: needs.should-process.outputs.task_type == 'thinking'
    runs-on: ubuntu-latest
    steps:
      - name: Get task details
        id: task
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            core.setOutput('title', issue.title);
            core.setOutput('body', issue.body || '');
            return issue;

      - name: Analyze
        id: analyze
        run: |
          PROMPT="You are a strategic advisor. Analyze this thoroughly:

          Question: ${{ steps.task.outputs.title }}

          Context: ${{ steps.task.outputs.body }}

          Provide:
          1. Clear analysis of the question/problem
          2. Key considerations and tradeoffs  
          3. Recommended approach
          4. Concrete next steps

          Think deeply but be actionable."

          RESPONSE=$(curl -s https://api.anthropic.com/v1/messages \
            -H "Content-Type: application/json" \
            -H "x-api-key: $ANTHROPIC_API_KEY" \
            -H "anthropic-version: 2023-06-01" \
            -d "{
              \"model\": \"claude-sonnet-4-20250514\",
              \"max_tokens\": 4096,
              \"messages\": [{\"role\": \"user\", \"content\": $(echo "$PROMPT" | jq -Rs .)}]
            }")

          CONTENT=$(echo "$RESPONSE" | jq -r '.content[0].text')
          
          echo "content<<EOF" >> $GITHUB_OUTPUT
          echo "$CONTENT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Post result
        uses: actions/github-script@v7
        with:
          script: |
            const content = `${{ steps.analyze.outputs.content }}`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `‚úÖ **Analysis complete:**\n\n${content}`
            });
            
            await github.rest.issues.removeLabel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              name: 'status:processing'
            });
            
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['status:ready']
            });

  # Triage tasks without a type - Claude reviews, refines, and classifies
  triage:
    needs: [should-process, start-processing]
    if: needs.should-process.outputs.task_type == 'auto'
    runs-on: ubuntu-latest
    steps:
      - name: Get task details
        id: task
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const labels = issue.labels.map(l => l.name).join(', ');
            core.setOutput('title', issue.title);
            core.setOutput('body', issue.body || '');
            core.setOutput('labels', labels);
            return issue;

      - name: Triage with Claude
        id: triage
        run: |
          PROMPT="You are a task triage assistant. Review this task and provide structured output.

          Task Title: ${{ steps.task.outputs.title }}
          Task Body: ${{ steps.task.outputs.body }}
          Existing Labels: ${{ steps.task.outputs.labels }}

          Analyze the task and respond in this EXACT format (each field on its own line):

          REFINED_TITLE: <A clearer, more actionable title, or KEEP if the original is good>
          REFINED_DESCRIPTION: <Enhanced description with clear scope and acceptance criteria, or KEEP if good>
          TYPE: <code|writing|thinking>
          PROJECT: <offerlab|influencekit|personal|unknown>
          CLARITY: <clear|needs_info>
          REASONING: <Brief 1-2 sentence explanation of your classification>

          Guidelines:
          - TYPE must be exactly one of: code, writing, thinking
          - code = software dev, bugs, features, refactoring
          - writing = emails, docs, blog posts, content creation
          - thinking = analysis, research, strategy, planning
          - PROJECT: infer from context if not labeled, use 'unknown' if unclear
          - CLARITY: 'needs_info' if the task is too vague to act on"

          RESPONSE=$(curl -s https://api.anthropic.com/v1/messages \
            -H "Content-Type: application/json" \
            -H "x-api-key: $ANTHROPIC_API_KEY" \
            -H "anthropic-version: 2023-06-01" \
            -d "{
              \"model\": \"claude-sonnet-4-20250514\",
              \"max_tokens\": 1024,
              \"messages\": [{\"role\": \"user\", \"content\": $(echo "$PROMPT" | jq -Rs .)}]
            }")

          CONTENT=$(echo "$RESPONSE" | jq -r '.content[0].text')

          # Parse structured response
          TYPE=$(echo "$CONTENT" | grep -i "^TYPE:" | sed 's/TYPE:[[:space:]]*//' | tr '[:upper:]' '[:lower:]' | tr -d '[:space:]')
          PROJECT=$(echo "$CONTENT" | grep -i "^PROJECT:" | sed 's/PROJECT:[[:space:]]*//' | tr '[:upper:]' '[:lower:]' | tr -d '[:space:]')
          CLARITY=$(echo "$CONTENT" | grep -i "^CLARITY:" | sed 's/CLARITY:[[:space:]]*//' | tr '[:upper:]' '[:lower:]' | tr -d '[:space:]')
          REFINED_TITLE=$(echo "$CONTENT" | grep -i "^REFINED_TITLE:" | sed 's/REFINED_TITLE:[[:space:]]*//')
          REASONING=$(echo "$CONTENT" | grep -i "^REASONING:" | sed 's/REASONING:[[:space:]]*//')

          # Extract refined description (may be multiline, so handle differently)
          REFINED_DESC=$(echo "$CONTENT" | sed -n '/^REFINED_DESCRIPTION:/,/^TYPE:/p' | head -n -1 | sed 's/REFINED_DESCRIPTION:[[:space:]]*//')

          # Defaults
          [[ -z "$TYPE" || ! "$TYPE" =~ ^(code|writing|thinking)$ ]] && TYPE="thinking"
          [[ -z "$CLARITY" ]] && CLARITY="clear"

          echo "type=$TYPE" >> $GITHUB_OUTPUT
          echo "project=$PROJECT" >> $GITHUB_OUTPUT
          echo "clarity=$CLARITY" >> $GITHUB_OUTPUT
          echo "reasoning=$REASONING" >> $GITHUB_OUTPUT

          # Handle multiline for refined title/desc
          echo "refined_title<<EOF" >> $GITHUB_OUTPUT
          echo "$REFINED_TITLE" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "refined_desc<<EOF" >> $GITHUB_OUTPUT
          echo "$REFINED_DESC" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          # Full response for comment
          echo "full_response<<EOF" >> $GITHUB_OUTPUT
          echo "$CONTENT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Post triage comment
        uses: actions/github-script@v7
        with:
          script: |
            const type = '${{ steps.triage.outputs.type }}';
            const project = '${{ steps.triage.outputs.project }}';
            const clarity = '${{ steps.triage.outputs.clarity }}';
            const reasoning = `${{ steps.triage.outputs.reasoning }}`;
            const refinedTitle = `${{ steps.triage.outputs.refined_title }}`;
            const refinedDesc = `${{ steps.triage.outputs.refined_desc }}`;

            let comment = `ü§ñ **Task Triaged**\n\n`;
            comment += `**Type:** \`${type}\`\n`;
            comment += `**Project:** \`${project}\`\n`;
            comment += `**Clarity:** ${clarity === 'clear' ? '‚úÖ Clear' : '‚ö†Ô∏è Needs more info'}\n\n`;

            if (refinedTitle && refinedTitle !== 'KEEP') {
              comment += `**Suggested Title:**\n> ${refinedTitle}\n\n`;
            }

            if (refinedDesc && refinedDesc !== 'KEEP') {
              comment += `**Suggested Description:**\n${refinedDesc}\n\n`;
            }

            comment += `**Reasoning:** ${reasoning}\n\n`;
            comment += `---\n*Proceeding to ${type} agent...*`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });

      - name: Handle unclear tasks
        if: steps.triage.outputs.clarity == 'needs_info'
        uses: actions/github-script@v7
        with:
          script: |
            // Mark as blocked if task needs clarification
            await github.rest.issues.removeLabel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              name: 'status:processing'
            }).catch(() => {});

            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['status:blocked']
            });

      - name: Add labels and re-queue
        if: steps.triage.outputs.clarity != 'needs_info'
        uses: actions/github-script@v7
        with:
          script: |
            const type = '${{ steps.triage.outputs.type }}';
            const project = '${{ steps.triage.outputs.project }}';
            const existingProject = '${{ needs.should-process.outputs.project }}';

            const typeLabel = `type:${type}`;
            const labelsToAdd = [typeLabel, 'status:queued'];

            // Add project label if we determined one and there isn't one already
            if (project && project !== 'unknown' && existingProject === 'unknown') {
              labelsToAdd.push(`project:${project}`);
            }

            // Add the labels - this will re-trigger the workflow with the type
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: labelsToAdd
            });

            // Remove processing
            await github.rest.issues.removeLabel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              name: 'status:processing'
            }).catch(() => {});
