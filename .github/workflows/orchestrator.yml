# .github/workflows/orchestrator.yml
#
# Processes tasks from the issue queue automatically.
# Triggers when a new issue is created with status:queued label.

name: Task Orchestrator

on:
  issues:
    types: [labeled]

permissions:
  issues: write
  contents: read

jobs:
  # Only run on queued tasks
  should-process:
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.check.outputs.should_run }}
      task_type: ${{ steps.check.outputs.task_type }}
      project: ${{ steps.check.outputs.project }}
    steps:
      - name: Check if should process
        id: check
        uses: actions/github-script@v7
        with:
          script: |
            const labels = context.payload.issue.labels.map(l => l.name);
            const triggeringLabel = context.payload.label?.name;

            // Only process when status:queued is the triggering label
            // This prevents duplicate runs when multiple labels are added at once
            if (triggeringLabel !== 'status:queued') {
              core.setOutput('should_run', 'false');
              return;
            }

            // Don't re-process
            if (labels.includes('status:processing') ||
                labels.includes('status:ready') ||
                labels.includes('status:blocked')) {
              core.setOutput('should_run', 'false');
              return;
            }

            core.setOutput('should_run', 'true');
            
            // Determine type
            if (labels.includes('type:code')) {
              core.setOutput('task_type', 'code');
            } else if (labels.includes('type:writing')) {
              core.setOutput('task_type', 'writing');
            } else if (labels.includes('type:thinking')) {
              core.setOutput('task_type', 'thinking');
            } else {
              core.setOutput('task_type', 'auto');
            }
            
            // Determine project
            const projectLabel = labels.find(l => l.startsWith('project:'));
            core.setOutput('project', projectLabel ? projectLabel.replace('project:', '') : 'unknown');

  # Mark as processing
  start-processing:
    needs: should-process
    if: needs.should-process.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Update labels
        uses: actions/github-script@v7
        with:
          script: |
            // Remove queued, add processing
            await github.rest.issues.removeLabel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              name: 'status:queued'
            }).catch(() => {});
            
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['status:processing']
            });

  # Route to appropriate processor
  process-code:
    needs: [should-process, start-processing]
    if: needs.should-process.outputs.task_type == 'code'
    runs-on: self-hosted
    steps:
      - name: Get task details
        id: task
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            core.setOutput('title', issue.title);
            core.setOutput('body', issue.body || '');
            core.setOutput('number', issue.number);
            return issue;

      - name: Determine target project
        id: project
        run: |
          PROJECT="${{ needs.should-process.outputs.project }}"
          case "$PROJECT" in
            offerlab)
              echo "dir=/home/runner/projects/offerlab" >> $GITHUB_OUTPUT
              echo "repo=bborn/offerlab" >> $GITHUB_OUTPUT
              echo "name=offerlab" >> $GITHUB_OUTPUT
              ;;
            influencekit)
              echo "dir=/home/runner/projects/influencekit" >> $GITHUB_OUTPUT
              echo "repo=bborn/influencekit" >> $GITHUB_OUTPUT
              echo "name=influencekit" >> $GITHUB_OUTPUT
              ;;
            *)
              echo "dir=" >> $GITHUB_OUTPUT
              echo "repo=" >> $GITHUB_OUTPUT
              echo "name=unknown" >> $GITHUB_OUTPUT
              ;;
          esac

      - name: Prepare workspace
        if: steps.project.outputs.dir != ''
        id: workspace
        working-directory: ${{ steps.project.outputs.dir }}
        run: |
          # Ensure we're on main and up to date
          git checkout main
          git pull origin main

          # Create task branch
          BRANCH="task-${{ steps.task.outputs.number }}"
          git checkout -b "$BRANCH" || git checkout "$BRANCH"
          echo "branch=$BRANCH" >> $GITHUB_OUTPUT

      - name: Run Claude Code
        if: steps.project.outputs.dir != ''
        id: claude
        working-directory: ${{ steps.project.outputs.dir }}
        env:
          GH_TOKEN: ${{ secrets.REPO_ACCESS_TOKEN }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: |
          PROMPT="You are working on: ${{ steps.project.outputs.name }}

          Task: ${{ steps.task.outputs.title }}

          ${{ steps.task.outputs.body }}

          Instructions:
          - Explore the codebase to understand the context
          - Implement the solution
          - Write tests if applicable
          - Commit your changes with clear messages
          - You have full access to all tools - use whatever you need

          When finished:
          - If complete: output TASK_COMPLETE on its own line
          - If you need input from me: output NEEDS_INPUT: followed by your question"

          # Run Claude with full permissions
          claude -p "$PROMPT" \
            --dangerously-skip-permissions \
            --max-turns 50 \
            > /tmp/claude_output.txt 2>&1 || true

          # Check result
          if grep -q "TASK_COMPLETE" /tmp/claude_output.txt; then
            echo "result=complete" >> $GITHUB_OUTPUT
          elif grep -q "NEEDS_INPUT" /tmp/claude_output.txt; then
            echo "result=needs_input" >> $GITHUB_OUTPUT
            grep "NEEDS_INPUT" /tmp/claude_output.txt | head -1 | sed 's/NEEDS_INPUT://' > /tmp/question.txt
          else
            echo "result=error" >> $GITHUB_OUTPUT
          fi

      - name: Push and create PR
        if: steps.claude.outputs.result == 'complete'
        id: pr
        working-directory: ${{ steps.project.outputs.dir }}
        env:
          GH_TOKEN: ${{ secrets.REPO_ACCESS_TOKEN }}
        run: |
          # Push the branch
          git push -u origin "${{ steps.workspace.outputs.branch }}"

          # Create PR (no reference to workflow repo)
          PR_URL=$(gh pr create \
            --title "${{ steps.task.outputs.title }}" \
            --body "## Summary

          ${{ steps.task.outputs.body }}

          ---
          *Automated PR*" \
            --head "${{ steps.workspace.outputs.branch }}")

          echo "url=$PR_URL" >> $GITHUB_OUTPUT

          # Return to main
          git checkout main

      - name: Update issue - success
        if: steps.claude.outputs.result == 'complete'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Post success comment
          BODY="âœ… **Task completed!**

          PR created: ${{ steps.pr.outputs.url }}"

          jq -n --arg body "$BODY" '{"body": $body}' > /tmp/payload.json
          curl -s -X POST \
            -H "Authorization: token ${GH_TOKEN}" \
            -H "Accept: application/vnd.github.v3+json" \
            -d @/tmp/payload.json \
            "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/comments"

      - name: Update issue - needs input
        if: steps.claude.outputs.result == 'needs_input'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          QUESTION=$(cat /tmp/question.txt 2>/dev/null || echo "Claude needs clarification")

          BODY="â“ **@bborn - Input needed**

          $QUESTION"

          jq -n --arg body "$BODY" '{"body": $body}' > /tmp/payload.json
          curl -s -X POST \
            -H "Authorization: token ${GH_TOKEN}" \
            -H "Accept: application/vnd.github.v3+json" \
            -d @/tmp/payload.json \
            "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/comments"

      - name: Update issue - error
        if: steps.claude.outputs.result == 'error' || steps.project.outputs.dir == ''
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          if [ -z "${{ steps.project.outputs.dir }}" ]; then
            MSG="Could not determine target project. Add a project label (e.g. project:offerlab)"
          else
            MSG="Task did not complete. Check runner logs for details."
          fi

          BODY="âš ï¸ **@bborn - Error**

          $MSG"

          jq -n --arg body "$BODY" '{"body": $body}' > /tmp/payload.json
          curl -s -X POST \
            -H "Authorization: token ${GH_TOKEN}" \
            -H "Accept: application/vnd.github.v3+json" \
            -d @/tmp/payload.json \
            "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/comments"

      - name: Update labels
        uses: actions/github-script@v7
        with:
          script: |
            const result = '${{ steps.claude.outputs.result }}';
            const newLabel = result === 'complete' ? 'status:ready' : 'status:blocked';

            await github.rest.issues.removeLabel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              name: 'status:processing'
            }).catch(() => {});

            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: [newLabel]
            });

  # Writing tasks - use Claude Code
  process-writing:
    needs: [should-process, start-processing]
    if: needs.should-process.outputs.task_type == 'writing'
    runs-on: self-hosted
    steps:
      - name: Get task details
        id: task
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            core.setOutput('title', issue.title);
            core.setOutput('body', issue.body || '');
            return issue;

      - name: Generate content with Claude Code
        id: generate
        env:
          GH_TOKEN: ${{ github.token }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: |
          PROMPT="You are a skilled writer. Please complete this task:

          Task: ${{ steps.task.outputs.title }}

          Details: ${{ steps.task.outputs.body }}

          Write the requested content. Be professional, clear, and match the appropriate tone.
          Output only the final content, no meta-commentary."

          # Run Claude Code (--max-turns 3 allows for response)
          claude -p "$PROMPT" --max-turns 3 > /tmp/content.txt 2>&1 || true

          # Build comment body
          {
            echo "âœ… **Content generated:**"
            echo ""
            echo "---"
            echo ""
            cat /tmp/content.txt
            echo ""
            echo "---"
            echo ""
            echo "*Copy the above content to use it.*"
          } > /tmp/body.txt

          # Post comment using curl
          jq -n --rawfile body /tmp/body.txt '{"body": $body}' > /tmp/payload.json
          curl -s -X POST \
            -H "Authorization: token ${GH_TOKEN}" \
            -H "Accept: application/vnd.github.v3+json" \
            -d @/tmp/payload.json \
            "https://api.github.com/repos/${{ github.repository }}/issues/${ISSUE_NUMBER}/comments"

      - name: Update labels
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.removeLabel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              name: 'status:processing'
            }).catch(() => {});

            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['status:ready']
            });

  # Thinking tasks - analysis with Claude Code
  process-thinking:
    needs: [should-process, start-processing]
    if: needs.should-process.outputs.task_type == 'thinking'
    runs-on: self-hosted
    steps:
      - name: Get task details
        id: task
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            core.setOutput('title', issue.title);
            core.setOutput('body', issue.body || '');
            return issue;

      - name: Analyze with Claude Code
        id: analyze
        env:
          GH_TOKEN: ${{ github.token }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: |
          PROMPT="You are a strategic advisor. Analyze this thoroughly:

          Question: ${{ steps.task.outputs.title }}

          Context: ${{ steps.task.outputs.body }}

          Provide:
          1. Clear analysis of the question/problem
          2. Key considerations and tradeoffs
          3. Recommended approach
          4. Concrete next steps

          Think deeply but be actionable."

          # Run Claude Code (--max-turns 3 allows for response)
          claude -p "$PROMPT" --max-turns 3 > /tmp/content.txt 2>&1 || true

          # Build comment body
          {
            echo "âœ… **Analysis complete:**"
            echo ""
            cat /tmp/content.txt
          } > /tmp/body.txt

          # Post comment using curl
          jq -n --rawfile body /tmp/body.txt '{"body": $body}' > /tmp/payload.json
          curl -s -X POST \
            -H "Authorization: token ${GH_TOKEN}" \
            -H "Accept: application/vnd.github.v3+json" \
            -d @/tmp/payload.json \
            "https://api.github.com/repos/${{ github.repository }}/issues/${ISSUE_NUMBER}/comments"

      - name: Update labels
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.removeLabel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              name: 'status:processing'
            }).catch(() => {});

            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['status:ready']
            });

  # Triage tasks without a type - Claude Code reviews, refines, and classifies
  triage:
    needs: [should-process, start-processing]
    if: needs.should-process.outputs.task_type == 'auto'
    runs-on: self-hosted
    steps:
      - name: Get task details
        id: task
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const labels = issue.labels.map(l => l.name).join(', ');
            core.setOutput('title', issue.title);
            core.setOutput('body', issue.body || '');
            core.setOutput('labels', labels);
            return issue;

      - name: Triage with Claude Code
        id: triage
        run: |
          PROMPT="You are a task triage assistant. Review this task and provide structured output.

          Task Title: ${{ steps.task.outputs.title }}
          Task Body: ${{ steps.task.outputs.body }}
          Existing Labels: ${{ steps.task.outputs.labels }}

          Analyze the task and respond in this EXACT format (each field on its own line):

          REFINED_TITLE: <A clearer, more actionable title, or KEEP if the original is good>
          REFINED_DESCRIPTION: <Enhanced description with clear scope and acceptance criteria, or KEEP if good>
          TYPE: <code|writing|thinking>
          PROJECT: <offerlab|influencekit|personal|unknown>
          CLARITY: <clear|needs_info>
          REASONING: <Brief 1-2 sentence explanation of your classification>

          Guidelines:
          - TYPE must be exactly one of: code, writing, thinking
          - code = software dev, bugs, features, refactoring
          - writing = emails, docs, blog posts, content creation
          - thinking = analysis, research, strategy, planning
          - PROJECT: infer from context if not labeled, use 'unknown' if unclear
          - CLARITY: 'needs_info' if the task is too vague to act on"

          # Run Claude Code (--max-turns 3 allows for response)
          CONTENT=$(claude -p "$PROMPT" --max-turns 3 2>&1) || true

          # Debug: show response
          echo "=== Claude Response ==="
          echo "$CONTENT"
          echo "======================="

          # Parse structured response
          TYPE=$(echo "$CONTENT" | grep -i "^TYPE:" | sed 's/TYPE:[[:space:]]*//' | tr '[:upper:]' '[:lower:]' | tr -d '[:space:]')
          PROJECT=$(echo "$CONTENT" | grep -i "^PROJECT:" | sed 's/PROJECT:[[:space:]]*//' | tr '[:upper:]' '[:lower:]' | tr -d '[:space:]')
          CLARITY=$(echo "$CONTENT" | grep -i "^CLARITY:" | sed 's/CLARITY:[[:space:]]*//' | tr '[:upper:]' '[:lower:]' | tr -d '[:space:]')
          REFINED_TITLE=$(echo "$CONTENT" | grep -i "^REFINED_TITLE:" | sed 's/REFINED_TITLE:[[:space:]]*//')
          REASONING=$(echo "$CONTENT" | grep -i "^REASONING:" | sed 's/REASONING:[[:space:]]*//')

          # Extract refined description (may be multiline, so handle differently)
          REFINED_DESC=$(echo "$CONTENT" | sed -n '/^REFINED_DESCRIPTION:/,/^TYPE:/p' | head -n -1 | sed 's/REFINED_DESCRIPTION:[[:space:]]*//')

          # Defaults
          [[ -z "$TYPE" || ! "$TYPE" =~ ^(code|writing|thinking)$ ]] && TYPE="thinking"
          [[ -z "$CLARITY" ]] && CLARITY="clear"

          # Debug parsed values
          echo "=== Parsed Values ==="
          echo "TYPE: $TYPE"
          echo "PROJECT: $PROJECT"
          echo "CLARITY: $CLARITY"
          echo "REASONING: $REASONING"
          echo "===================="

          echo "type=$TYPE" >> $GITHUB_OUTPUT
          echo "project=$PROJECT" >> $GITHUB_OUTPUT
          echo "clarity=$CLARITY" >> $GITHUB_OUTPUT
          echo "reasoning=$REASONING" >> $GITHUB_OUTPUT

          # Handle multiline for refined title/desc
          echo "refined_title<<EOF" >> $GITHUB_OUTPUT
          echo "$REFINED_TITLE" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          echo "refined_desc<<EOF" >> $GITHUB_OUTPUT
          echo "$REFINED_DESC" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          # Full response for comment
          echo "full_response<<EOF" >> $GITHUB_OUTPUT
          echo "$CONTENT" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Post triage comment
        uses: actions/github-script@v7
        with:
          script: |
            const type = '${{ steps.triage.outputs.type }}';
            const project = '${{ steps.triage.outputs.project }}';
            const clarity = '${{ steps.triage.outputs.clarity }}';
            const reasoning = `${{ steps.triage.outputs.reasoning }}`;
            const refinedTitle = `${{ steps.triage.outputs.refined_title }}`;
            const refinedDesc = `${{ steps.triage.outputs.refined_desc }}`;

            let comment = `ðŸ¤– **Task Triaged**\n\n`;
            comment += `**Type:** \`${type}\`\n`;
            comment += `**Project:** \`${project}\`\n`;
            comment += `**Clarity:** ${clarity === 'clear' ? 'âœ… Clear' : 'âš ï¸ Needs more info'}\n\n`;

            if (refinedTitle && refinedTitle !== 'KEEP') {
              comment += `**Suggested Title:**\n> ${refinedTitle}\n\n`;
            }

            if (refinedDesc && refinedDesc !== 'KEEP') {
              comment += `**Suggested Description:**\n${refinedDesc}\n\n`;
            }

            comment += `**Reasoning:** ${reasoning}\n\n`;
            comment += `---\n*Proceeding to ${type} agent...*`;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });

      - name: Handle unclear tasks
        if: steps.triage.outputs.clarity == 'needs_info'
        uses: actions/github-script@v7
        with:
          script: |
            // Mark as blocked if task needs clarification
            await github.rest.issues.removeLabel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              name: 'status:processing'
            }).catch(() => {});

            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['status:blocked']
            });

      - name: Add labels and re-queue
        if: steps.triage.outputs.clarity != 'needs_info'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.REPO_ACCESS_TOKEN }}
          script: |
            const type = '${{ steps.triage.outputs.type }}';
            const project = '${{ steps.triage.outputs.project }}';
            const existingProject = '${{ needs.should-process.outputs.project }}';

            const typeLabel = `type:${type}`;
            const labelsToAdd = [typeLabel, 'status:queued'];

            // Add project label if we determined one and there isn't one already
            if (project && project !== 'unknown' && existingProject === 'unknown') {
              labelsToAdd.push(`project:${project}`);
            }

            // Add the labels - this will re-trigger the workflow with the type
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: labelsToAdd
            });

            // Remove processing
            await github.rest.issues.removeLabel({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              name: 'status:processing'
            }).catch(() => {});
